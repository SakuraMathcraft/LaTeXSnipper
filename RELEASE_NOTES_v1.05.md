# LaTeXSnipper v1.05 紧急修复说明

发布日期：2026-02-23

本次为 `v1.05` 发布后的紧急修复，不引入新模型，不改识别主链路，重点处理稳定性和可维护性问题。

## 主要修复

### 1. pix2text 启动探测与缓存损坏自愈

- 重构 `probe -> bootstrap` 日志与判定逻辑，减少“日志看起来失败但实际可用”的误导。
- 新增 ONNX 缓存损坏检测：
  - 命中 `missing encoder/decoder onnx` 类错误时，自动清理损坏目录并重试一次。
  - 主要解决用户端模型缓存半下载/不完整导致的加载异常。
- 预热成功后增加常驻 worker 就绪日志（可用时带 PID），便于确认常驻进程是否真正拉起。
- 如果仍提示 pix2text 加载失败：
  - 打开设置页新增的 pix2text 缓存目录入口；
  - 删除缓存中的 `1.1` 目录；
  - 重启程序触发重新下载。

### 2. 初始化与运行日志改为 GUI 窗口

- 启动日志从系统终端改为 GUI 文本窗口（“初始化与运行日志”）。
- 支持滚动查看、文本选择复制，避免 Windows 终端“选择模式”导致进程暂停的问题。
- 增加 `复制全部` 和 `清空视图` 的 `InfoBar` 反馈，交互不再阻塞。
- 优化启动阶段窗口行为，减少无意义的空白终端闪现。

### 3. app.log 可用性修复

- 修复 `app.log` 只有“日志初始化完成”重复行的问题。
- 增加 `print -> app.log` 桥接，运行期关键输出会落盘，便于用户提交可分析日志。
- 启动头信息改为 `session start` 形式（包含 `pid / exe / log path`），便于定位具体会话。

### 4. 依赖向导与 GPU 层修复

- 安装完成后的层验证改为独立 worker 执行，避免主对话框长时间“无响应”。
- 完成/失败提示流程收敛，减少“按钮点击无反应”的交互问题。
- `HEAVY_GPU` 下的 `torch/torchvision/torchaudio` 改为强制使用 PyTorch CUDA 索引，不再先走普通 PyPI/清华后再回退。
- GPU 轮子索引按 CUDA 版本矩阵选择；无法精确匹配时回退 `cu118`（仍为 GPU 轮子）。
- 检测到已安装为 CPU 轮子（如 `+cpu` 或无 `+cu`）时，不再“已安装跳过”，而是强制重装 GPU 版本。
- 检测到 CUDA tag 不匹配（如已装 `cu118`，目标 `cu126`）时，自动重装到目标 tag。
- 切换 `HEAVY_CPU` / `HEAVY_GPU` 时，会先卸载对侧 torch 三件套，避免混装。
- 状态文件写回增加互斥约束：`HEAVY_CPU` 与 `HEAVY_GPU` 不会同时保留。

### 5. 设置页与更新窗口细节修复

- 设置页新增 pix2text 缓存目录入口，便于用户手动检查/清理缓存。
- 更新窗口“复制链接”提示从阻塞弹窗改为 `InfoBar`，减少打断。
- 识别完成托盘提示默认关闭，避免连续识别时刷屏。

### 6. 用户数据路径统一

- 收藏夹与历史记录路径统一走 `.latexsnipper` 用户数据目录解析逻辑。
- 配置、历史、收藏与日志更集中，便于备份与问题排查。
- `v1.05` 以前版本用户建议手动迁移：
  - `C:\Users\<用户名>\favorites.json`
  - `C:\Users\<用户名>\history.json`
  - `C:\Users\<用户名>\LaTeXSnipper_config.json`
  - 到 `C:\Users\<用户名>\.latexsnipper\` 下统一管理。

## 兼容性说明

- 模型体系仍为 `pix2text-only`（与 `v1.05` 一致）。
- 依赖层定义仍为 `BASIC / CORE / HEAVY_CPU / HEAVY_GPU`，无破坏性变更。
- 对已安装用户，建议在设置页执行一次依赖校验，确认层状态与运行时一致。
