name: Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-windows:
    name: Build Windows Package
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel setuptools
          python -m pip install pyinstaller==6.11.1
          python -m pip install `
            "PyQt6~=6.9.1" `
            "PyQt6-WebEngine~=6.9.0" `
            "PyQt6-Fluent-Widgets~=1.8.6" `
            "pillow~=11.0.0" `
            "pyperclip~=1.11.0" `
            "packaging~=25.0" `
            "requests~=2.32.5" `
            "matplotlib~=3.8.3" `
            "latex2mathml~=3.78.0" `
            "sympy~=1.13.3" `
            "mpmath~=1.3.0" `
            "networkx~=3.2.1" `
            "humanfriendly~=10.0" `
            "onnx~=1.15.0" `
            "pywin32~=308"

      - name: Build with PyInstaller
        shell: pwsh
        run: |
          pyinstaller LaTeXSnipper.spec --clean

      - name: Package artifacts
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $folder = "LaTeXSnipper-$tag-windows-x64"
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          Copy-Item "dist/LaTeXSnipper" "artifacts/$folder" -Recurse -Force
          Compress-Archive -Path "artifacts/$folder/*" -DestinationPath "artifacts/$folder.zip" -Force
          if (Test-Path "dist/LaTeXSnipper/LaTeXSnipper.exe") {
            Copy-Item "dist/LaTeXSnipper/LaTeXSnipper.exe" "artifacts/LaTeXSnipper-$tag.exe" -Force
          }

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.ref_name }}
          path: artifacts/*

      - name: Publish GitHub Release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            artifacts/*.zip
            artifacts/*.exe
